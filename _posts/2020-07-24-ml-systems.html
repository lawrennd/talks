---
title: "Introduction to Machine Learning Systems"
abstract: "This notebook introduces some of the challenges of building machine learning data systems. It will introduce you to concepts around joining of databases together. The storage and manipulation of data is at the core of machine learning systems and data science. The goal of this notebook is to introduce the reader to these concepts, not to authoritatively answer any questions about the state of Nigerian health facilities or Covid19, but it may give you ideas about how to try and do that in your own country."
author:
- given: Eric
  family: Meissner
  url: 
  institute: 
  twitter: 
  gscholar: 
  orchid: 
- given: Andrei
  family: Paleyes
  url: 
  institute: 
  twitter: 
  gscholar: 
  orchid: 
- given: Neil D.
  family: Lawrence
  url: 
  institute: 
  twitter: 
  gscholar: 
  orchid: 
date: 2020-07-24
published: 2020-07-24
week: 0
reveal: 2020-07-24-ml-systems.slides.html
ipynb: 2020-07-24-ml-systems.ipynb
layout: talk
categories:
- notes
---


<div style="display:none">
  $${% include talk-notation.tex %}$$
</div>

<script src="/talks/figure-magnify.js"></script>
<script src="/talks/figure-animate.js"></script>
    
<div id="modal-frame" class="modal">
  <span class="close" onclick="closeMagnify()">&times;</span>
  <div class="modal-figure">
    <div class="figure-frame">
      <div class="modal-content" id="modal01"></div>
      <!--<img class="modal-content" id="object01">-->
    </div>
    <div class="caption-frame" id="modal-caption"></div>
  </div>
</div>	  

<!-- Do not edit this file locally. -->
<!---->
<!-- Do not edit this file locally. -->
<!-- Do not edit this file locally. -->
<!-- The last names to be defined. Should be defined entirely in terms of macros from above-->
<!--

-->
<h2 id="question">Question</h2>
<p>In this notebook, we explore the question of health facility distribution in Nigeria, spatially, and in relation to population density.</p>
<p>We answer and visualize the question “How does the number of health facilities per capita vary across Nigeria?”</p>
<p>Rather than focussing purely on using tools like <code>pandas</code> to manipulate the data, our focus will be on introducing some concepts from databases.</p>
<p>Machine learning can be summarized as <br /><span class="math display">$$
\text{model} + \text{data} \xrightarrow{\text{compute}} \text{prediction}
$$</span><br /> and many machine learning courses focus a lot on the model part. But to build a machine learning system in practice, a lot of work has to be put into the data part. This notebook gives some pointers on that work and how to think about your machine learning systems design.</p>
<h2 id="datasets">Datasets</h2>
<p>In this notebook , we download 3 datasets: * Nigeria NMIS health facility data * Population data for Administrative Zone 1 (states) areas in Nigeria * Map boundaries for Nigerian states (for plotting and binning) * Covid cases across Nigeria (as of May 20, 2020)</p>
<p>But joining these data sets together is just an example. As another example, you could think of <a href="https://safeboda.com/ng/">SafeBoda</a>, a ride-hailing app that’s available in Lagos and Kampala. As well as looking at the health examples, try to imagine how SafeBoda may have had to design their systems to be scalable and reliable for storing and sharing data.</p>
<h2 id="imports-installs-and-downloads">Imports, Installs, and Downloads</h2>
<p>First, we’re going to download some particular python libraries for dealing with geospatial data. We’re dowloading <a href="https://geopandas.org"><code>geopandas</code></a> which will help us deal with ‘shape files’ that give the geographical lay out of Nigeria. We’ll also download <a href="https://pygeos.readthedocs.io/en/latest/"><code>pygeos</code></a>, a library for dealing with points rapidly in python. And finally, to get a small database set up running quickly, we’re installing <a href="https://pypi.org/project/csv-to-sqlite/"><code>csv-to-sqlite</code></a> which allows us to convert CSV data to a simple database.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">%</span>pip install geopandas pygeos</span></code></pre></div>
<h2 id="databases-and-joins">Databases and Joins</h2>
<p>The main idea we will be working with today is called the ‘join’. A join does exactly what it sounds like, it combines two databases.</p>
<p>You have already started to look at data structures, in particular you have been learning about <code>pandas</code> which is a great way of storing and structuring your data set to make it easier to plot and manipulate your data.</p>
<p>Pandas is great for the data scientist to analyze data because it makes many operations easier. But it is not so good for building the machine learning system. In a machine learning system, you may have to handle a lot of data. Even if you start with building a system where you only have a few customers, perhaps you build an online taxi system (like SafeBoda) for Kampala. Maybe you will have 50 customers. Then maybe your system can be handled with some python scripts and pandas.</p>
<h2 id="scaling-ml-systems">Scaling ML Systems</h2>
<p>But what if you are succesful? What if everyone in Kampala wants to use your system? There are 1.5 million people in Kampala and maybe 100,000 Boda Boda drivers.</p>
<p>What if you are even more succesful? What if everyone in Lagos wants to use your system? There are around 20 million people in Lagos … and maybe as many Okada drivers as people in Kampala!</p>
<p>We want to build safe and reliable machine learning systems. Building them from pandas and python is about as safe and reliable as <a href="https://www.monitor.co.ug/News/National/Boda-accidents-kill-10-city-UN-report-Kampala/688334-4324032-15oru2dz/index.html">taking six children to school on a boda boda</a>.</p>
<p>To build a reliable system, we need to turn to <em>databases</em>. In this notebook <a href="https://en.wikipedia.org/wiki/Join_(SQL)">we’ll be focussing on SQL databases</a> and how you bring together different streams of data in a Machine Learning System.</p>
<p>In a machine learning system, you will need to bring different data sets together. In database terminology this is known as a ‘join’. You have two different data sets, and you want to join them together. Just like you can join two pieces of metal using a welder, or two pieces of wood with screws.</p>
<p>But instead of using a welder or screws to join data, we join it using particular columns of the data. We can join data together using people’s names. One database may contain where people live, another database may contain where they go to school. If we join these two databases we can have a database which shows where people live and where they got to school.</p>
<p>In the notebook, we will join together some data about where the health centres are in Nigeria and where the have been cases of Covid19. There are other challenges in the ML System Design that are not going to be covered here. They include: how to update the data bases, and how to control access to the data bases from different users (boda boda drivers, riders, administrators etc).</p>
<h2 id="hospital-data">Hospital Data</h2>
<p>The first and primary dataset we use is the NMIS health facility dataset, which contains data on the location, type, and staffing of health facilities across Nigeria.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>urllib.request.urlretrieve(<span class="st">&#39;https://energydata.info/dataset/f85d1796-e7f2-4630-be84-79420174e3bd/resource/6e640a13-cab4-457b-b9e6-0336051bac27/download/healthmopupandbaselinenmisfacility.csv&#39;</span>, <span class="st">&#39;healthmopupandbaselinenmisfacility.csv&#39;</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>hospital_data <span class="op">=</span> pd.read_csv(<span class="st">&#39;healthmopupandbaselinenmisfacility.csv&#39;</span>)</span></code></pre></div>
<p>It’s always a good idea to inspect your data once it’s downloaded to check it contains what you expect. In <code>pandas</code> you can do this with the <code>.head()</code> method. That allows us to see the first few entries of the <code>pandas</code> data structure.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>hospital_data.head()</span></code></pre></div>
<p>We can also check in <code>pandas</code> what the different columns of the data frame are to see what it contains.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>hospital_data.columns</span></code></pre></div>
<p>We can immiediately see that there are facility names, dates, and some characteristics of each health center such as number of doctors etc. As well as all that, we have two fields, <code>latitude</code> and <code>longitude</code> that likely give us the hospital locaiton. Let’s plot them to have a look.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>plt.plot(hospital_data.longitude, hospital_data.latitude,<span class="st">&#39;ro&#39;</span>, alpha<span class="op">=</span><span class="fl">0.01</span>)</span></code></pre></div>
<p>There we have the location of these different hospitals. We set alpha in the plot to 0.01 to make the dots transparent, so we can see the locations of each health center.</p>
<h2 id="administrative-zone-geo-data">Administrative Zone Geo Data</h2>
<p>A very common operation is the need to map from locations in a country to the administrative regions. If we were building a ride sharing app, we might also want to map riders to locations in the city, so that we could know how many riders we had in different city areas.</p>
<p>Administrative regions have various names like cities, counties, districts or states. These conversions for the administrative regions are important for getting the right information to the right people.</p>
<p>Of course, if we had a knowlegdeable Nigerian, we could ask her about what the right location for each of these health facilities is, which state is it in? But given that we have the latitude and longitude, we should be able to find out automatically what the different states are.</p>
<p>This is where “geo” data becomes important. We need to download a dataset that stores the location of the different states in Nigeria. These files are known as ‘outline’ files. Because the draw the different states of different countries in outline.</p>
<p>There are special databases for storing this type of information, the database we are using is in the <code>gdb</code> or GeoDataBase format. It comes in a zip file. Let’s download the outline files for the Nigerian states. They have been made available by the <a href="https://data.humdata.org/">Humanitarian Data Exchange</a>, you can also find other states data from the same site.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> zipfile</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>admin_zones_url <span class="op">=</span> <span class="st">&#39;https://data.humdata.org/dataset/81ac1d38-f603-4a98-804d-325c658599a3/resource/0bc2f7bb-9ff6-40db-a569-1989b8ffd3bc/download/nga_admbnda_osgof_eha_itos.gdb.zip&#39;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>_, msg <span class="op">=</span> urllib.request.urlretrieve(admin_zones_url, <span class="st">&#39;nga_admbnda_osgof_eha_itos.gdb.zip&#39;</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="cf">with</span> zipfile.ZipFile(<span class="st">&#39;/content/nga_admbnda_osgof_eha_itos.gdb.zip&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb9-4"><a href="#cb9-4"></a>    zip_ref.extractall(<span class="st">&#39;/content/nga_admbnda_osgof_eha_itos.gdb&#39;</span>)</span></code></pre></div>
<p>Now we have this data of the outlines of the different states in Nigeria.</p>
<p>The next thing we need to know is how these health facilities map onto different states in Nigeria. Without “binning” facilities somehow, it’s difficult to effectively see how they are distributed across the country.</p>
<p>We do this by finding a “geo” dataset that contains the spatial outlay of Nigerian states by latitude/longitude coordinates. The dataset we use is of the “gdb” (GeoDataBase) type and comes as a zip file. We don’t need to worry much about this datatype for this notebook, only noting that geopandas knows how to load in the dataset, and that it contains different “layers” for the same map. In this case, each layer is a different degree of granularity of the political boundaries, with layer 0 being the whole country, 1 is by state, or 2 is by local government. We’ll go with a state level view for simplicity, but as an excercise you can change it to layer 2 to view the distribution by local government.</p>
<p>Once we have these <code>MultiPolygon</code> objects that define the boundaries of different states, we can perform a spatial join (sjoin) from the coordinates of individual health facilities (which we already converted to the appropriate <code>Point</code> type when moving the health data to a GeoDataFrame.)</p>
<h2 id="joining-a-geodataframe">Joining a GeoDataFrame</h2>
<p>The first database join we’re going to do is a special one, it’s a ‘spatial join’. We’re going to join together the locations of the hospitals with their states.</p>
<p>This join is unusual because it requires some mathematics to get right. The outline files give us the borders of the different states in latitude and longitude, the health facilities have given locations in the country.</p>
<p>A spatial join involves finding out which state each health facility belongs to. Fortunately, the mathematics you need is already programmed for you in GeoPandas. That means all we need to do is convert our <code>pandas</code> dataframe of health facilities into a <code>GeoDataFrame</code> which allows us to do the spatial join.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>hosp_gdf <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb11-2"><a href="#cb11-2"></a>    hospital_data, geometry<span class="op">=</span>gpd.points_from_xy(hospital_data.longitude, hospital_data.latitude))</span>
<span id="cb11-3"><a href="#cb11-3"></a>hosp_gdf.crs <span class="op">=</span> <span class="st">&quot;EPSG:4326&quot;</span></span></code></pre></div>
<p>There are some technial details here: the <code>crs</code> refers to the coordinate system in use by a particular GeoDataFrame. <code>EPSG:4326</code> is the standard coordinate system of latitude/longitude.</p>
<h2 id="your-first-join-converting-gps-coordinates-to-states">Your First Join: Converting GPS Coordinates to States</h2>
<p>Now we have the data in the <code>GeoPandas</code> format, we can start converting into states. We will use the <a href="https://pypi.org/project/Fiona/"><code>fiona</code></a> library for reading the right layers from the files. Before we do the join, lets plot the location of health centers and states on the same map.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="im">import</span> fiona</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>states_file <span class="op">=</span> <span class="st">&quot;/content/nga_admbnda_osgof_eha_itos.gdb/nga_admbnda_osgof_eha_itos.gdb/nga_admbnda_osgof_eha_itos.gdb/nga_admbnda_osgof_eha_itos.gdb/&quot;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co"># geopandas included map, filtered to just Nigeria</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>world <span class="op">=</span> gpd.read_file(gpd.datasets.get_path(<span class="st">&#39;naturalearth_lowres&#39;</span>))</span>
<span id="cb13-5"><a href="#cb13-5"></a>world.crs <span class="op">=</span> <span class="st">&quot;EPSG:4326&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>nigeria <span class="op">=</span> world[(world[<span class="st">&#39;name&#39;</span>] <span class="op">==</span> <span class="st">&#39;Nigeria&#39;</span>)]</span>
<span id="cb13-7"><a href="#cb13-7"></a>base <span class="op">=</span> nigeria.plot(color<span class="op">=</span><span class="st">&#39;white&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>, alpha<span class="op">=</span><span class="dv">0</span>, figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">11</span>))</span>
<span id="cb13-8"><a href="#cb13-8"></a></span>
<span id="cb13-9"><a href="#cb13-9"></a>layers <span class="op">=</span> fiona.listlayers(states_file)</span>
<span id="cb13-10"><a href="#cb13-10"></a>zones_gdf <span class="op">=</span> gpd.read_file(states_file, layer<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-11"><a href="#cb13-11"></a>zones_gdf.crs <span class="op">=</span> <span class="st">&quot;EPSG:4326&quot;</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>zones_gdf <span class="op">=</span> zones_gdf.set_index(<span class="st">&#39;admin1Name_en&#39;</span>)</span>
<span id="cb13-13"><a href="#cb13-13"></a>zones_gdf.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">&#39;white&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb13-14"><a href="#cb13-14"></a></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="co"># We can now plot our ``GeoDataFrame``.</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>hosp_gdf.plot(ax<span class="op">=</span>base, color<span class="op">=</span><span class="st">&#39;b&#39;</span>, alpha<span class="op">=</span><span class="fl">0.02</span>, )</span>
<span id="cb13-17"><a href="#cb13-17"></a></span>
<span id="cb13-18"><a href="#cb13-18"></a>plt.show()</span></code></pre></div>
<h2 id="performing-the-spatial-join">Performing the Spatial Join</h2>
<p>We’ve now plotted the different health center locations across the states. You can clearly see that each of the dots falls within a different state. For helping the visualisation, we’ve made the dots somewhat transparent (we set the <code>alpha</code> in the plot). This means that we can see the regions where there are more health centers, you should be able to spot where the major cities in Nigeria are given the increased number of health centers in those regions.</p>
<p>Of course, we can now see by eye, which of the states each of the health centers belongs to. But we want the computer to do our join for us. <code>GeoPandas</code> provides us with the spatial join. Here we’re going to do a <a href="https://en.wikipedia.org/wiki/Join_(SQL)#Left_outer_join"><code>left</code> or <code>outer</code> join</a>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="im">from</span> geopandas.tools <span class="im">import</span> sjoin</span></code></pre></div>
<p>We have two GeoPandas data frames, <code>hosp_gdf</code> and <code>zones_gdf</code>. Let’s have a look at the columns the contain.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>hosp_gdf.columns</span></code></pre></div>
<p>We can see that this is the GeoDataFrame containing the information about the hospital. Now let’s have a look at the <code>zones_gdf</code> data frame.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>zones_gdf.columns</span></code></pre></div>
<p>You can see that this data frame has a different set of columns. It has all the different administrative regions. But there is one column name that overlaps. We can find it by looking for the intersection between the two sets.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="bu">set</span>(hosp_gdf.columns).intersection(<span class="bu">set</span>(zones_gdf.columns))</span></code></pre></div>
<p>Here we’ve converted the lists of columns into python ‘sets’, and then looked for the intersection. The <em>join</em> will occur on the intersection between these columns. It will try and match the geometry of the hospitals (their location) to the geometry of the states (their outlines). This match is done in one line in GeoPandas.</p>
<p>We’re having to use GeoPandas because this join is a special one based on geographical locations, if the join was on customer name or some other discrete variable, we could do the join in pandas or directly in SQL.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>hosp_state_joined <span class="op">=</span> sjoin(hosp_gdf, zones_gdf, how<span class="op">=</span><span class="st">&#39;left&#39;</span>)</span></code></pre></div>
<p>The intersection of the two data frames indicates how the two data frames will be joined (if there’s no intersection, they can’t be joined). It’s like indicating the two holes that would need to be bolted together on two pieces of metal. If the holes don’t match, the join can’t be done. There has to be an intersection.</p>
<p>But what will the result look like? Well the join should be the ‘union’ of the two data frames. We can have a look at what the union should be by (again) converting the columns to sets.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="bu">set</span>(hosp_gdf.columns).union(<span class="bu">set</span>(zones_gdf.columns))</span></code></pre></div>
<p>That gives a list of all the columns (notice that ‘geometry’ only appears once).</p>
<p>Let’s check that’s what the join command did, by looking at the columns of our new data frame, <code>hosp_state_joined</code>. Notice also that there’s a new column: <code>index_right</code>. The two original data bases had separate indices. The <code>index_right</code> column represents the index from the <code>zones_gdf</code>, which is the Nigerian state.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="bu">set</span>(hosp_state_joined.columns)</span></code></pre></div>
<p>Great! They are all there! We have completed our join. We had two separate data frames with information about states and information about hospitals. But by performing an ‘outer’ or a ‘left’ join, we now have a single data frame with all the information in the same place! Let’s have a look at the first frew entries in the new data frame.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>hosp_state_joined.head()</span></code></pre></div>
<h2 id="sql-database">SQL Database</h2>
<p>Our first join was a special one, because it involved spatial data. That meant using the special <code>gdb</code> format and the <code>GeoPandas</code> tool for manipulating that data. But we’ve now saved our updated data in a new file.</p>
<p>To do this, we use the command line utility that comes standard for SQLite database creation. SQLite is a simple database that’s useful for playing with database commands on your local machine. For a real system, you would need to set up a server to run the database. The server is a separate machine with the job of answering database queries. SQLite pretends to be a proper database, but doesn’t require us to go to the extra work of setting up a server. Popular SQL server software includes <a href="https://www.mysql.com/"><code>MySQL</code></a> which is free or <a href="https://www.microsoft.com/en-gb/sql-server/sql-server-2019">Microsoft’s SQL Server</a>.</p>
<p>A typical machine learning installation might have you running a database from a cloud service (such as AWS, Azure or Google Cloud Platform). That cloud service would host the database for you and you would pay according to the number of queries made.</p>
<p>Many start-up companies were formed on the back of a <code>MySQL</code> server hosted on top of AWS. You can <a href="https://aws.amazon.com/getting-started/hands-on/create-mysql-db/">read how to do that here</a>.</p>
<p>If you were designing your own ride hailing app, or any other major commercial software you would want to investigate whether you would need to set up a central SQL server in one of these frameworks.</p>
<p>Today though, we’ll just stick to SQLite which gives you a sense of the database without the time and expense of setting it up on the cloud. As well as showing you the SQL commands (which is often what’s used in a production ML system) we’ll also give the equivalent <code>pandas</code> commands, which would often be what you would use when you’re doing data analysis in <code>python</code> and <code>Jupyter</code>.</p>
<h2 id="accessing-the-sql-database">Accessing the SQL Database</h2>
<p>Now that we have a SQL database, we can create a connection to it and query it using SQL commands. Let’s try to simply select the data we wrote to it, to make sure its the same.</p>
<p>Start by making a connection to the database. This will often be done via remote connections, but for this example we’ll connect locally to the database using the filepath directly.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>conn <span class="op">=</span> create_connection(<span class="st">&quot;db.sqlite&quot;</span>)</span></code></pre></div>
<p>Now that we have a connection, we can write a command and pass it to the database.</p>
<p>To access a data base, the first thing that is made is a connection. Then SQL is used to extract the information required. A typical SQL command is <code>SELECT</code>. It allows us to extract rows from a given table. It operates a bit like the <code>.head()</code> method in <code>pandas</code>, it will return the first <code>N</code> rows (by default the <code>.head()</code> command returns the first 5 rows, but you can set <code>n</code> to whatever you like. Here we’ve included a default value of 5 to make it match the <code>pandas</code> command.</p>
<p>The python library, <code>sqlite3</code>, allows us to access the SQL database directly from python. We do this using an <code>execute</code> command on the connection.</p>
<p>Typically, its good software engineering practice to ‘wrap’ the database command in some python code. This allows the commands to be maintained. Below we wrap the SQL command</p>
<pre><code>SELECT * FROM [table_name] LIMIT : N</code></pre>
<p>in python code. This SQL command selects the first <code>N</code> entries from a given database called <code>table_name</code>.</p>
<p>We can pass the <code>table_name</code> and number of rows, <code>N</code> to the python command.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>Let<span class="st">&#39;s have a go at calling the command to extract the first three facilities from our health center database. Let&#39;</span>s <span class="cf">try</span> creating a function that does the same thing the pandas .head() method does so we can inspect our database.</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">def</span> head(conn, table, n<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb25-2"><a href="#cb25-2"></a>  rows <span class="op">=</span> select_top(conn, table)</span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="cf">for</span> r <span class="kw">in</span> rows:</span>
<span id="cb25-4"><a href="#cb25-4"></a>      <span class="bu">print</span>(r)</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>head(conn, <span class="st">&#39;facilities&#39;</span>)</span></code></pre></div>
<p>Great! We now have the data base in SQLite, and some python functions that operate on the data base by wrapping SQL commands.</p>
<p>We will return to the SQL command style after download and add the other datasets to the database using a combination of <code>pandas</code> and the <code>csv-to-sqlite</code> utility.</p>
<p>Our next task will be to introduce data on COVID19 so that we can join that to our other data sets.</p>
<h2 id="thanks">Thanks!</h2>
<p>For more information on these subjects and more you might want to check the following resources.</p>
<ul>
<li>twitter: <a href="https://twitter.com/lawrennd">@lawrennd</a></li>
<li>podcast: <a href="http://thetalkingmachines.com">The Talking Machines</a></li>
<li>newspaper: <a href="http://www.theguardian.com/profile/neil-lawrence">Guardian Profile Page</a></li>
<li>blog: <a href="http://inverseprobability.com/blog.html">http://inverseprobability.com</a></li>
</ul>
<h1 id="references">References</h1>

